---
title: "Gunshots and Turf Wars:"
subtitle: Inferring Gang Territories from Administrative Data
date: "24 March 2020"
author: Brendan Cooley | Noam Reich
position: Ph.D. Candidates
institution: Princeton University
email: "bcooley (at) princeton.edu | noamg (at) princeton.edu"

bibliography: /Users/brendancooley/Dropbox (Princeton)/References/library.bib
biblio-style: apsr

backgroundTitle: "other/chi_aerial.jpg"

output:
  revealjs::revealjs_presentation:
    template: "css/cooley-reveal.html"
    css: "css/cooley-reveal.css"
    backgroundTransition: none
    transition: none
    self_contained: false
    # reveal_plugins: ["notes"]
    lib_dir: index_files
    fig_caption: true
    reveal_options:
      slideNumber: false
      progress: false
      controls: true
---


```{r references, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}

if (file.exists('references.RData')) load('references.RData')

```

```{r, child = "07_slides/introduction.rmd"}
```

```{r, child = "07_slides/data.rmd"}
```

# Old

## Gunshots

<center>
![](figs/shootings_animated.gif#center){width=70%}
</center>

## Gunshots

<!-- ```{r gunshots_tracts, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5.5, dpi=300}

chi_shootings_tracts_mfirst_map

``` -->

# Model

**Observables**

- $\mathcal{N} = \left\{1, ..., N \right\}$ - districts
- $1, ..., T$ - periods (months)
- $r_i$ - the number of residents in territory $i$
- $v_i^t = x_i^t + y_i^t$
  - $y_i^t$ - non-gang related shootings
  - $x_i^t$ - gang-related shootings 

**Unobservables**

- $\mathcal{K} = \left\{1, ..., K \right\}$ - gangs
- $\pi : \mathcal{N} \rightarrow \left\{ 0, \mathcal{K} \right\}$ - partition function
  + $\pi(i) = 0$ indicates the absence of any gang activity. 
  + $\mathcal{N}_k$ - the set of territories controlled by gang $k$ 
  + $n_k = | \mathcal{K}_k |$ - the number of territories controlled by gang $k$
  + $\mathcal{K}_0$ - the set of unoccupied territories. 
  + $m_k$ - the number of members of gang $k$

## Varieties of Violence

**Non-Gang**

- $\eta_i$ - the probability a resident commits a shooting 
  + independent across districts

. . .

**Intra-Gang**

- $\xi_k^t$ - probability a member of gang $k$ shoots a member of his own gang
- **Assumption `r Aintragang_nz` (Non-negativity):** $\mathbb{E} [ \xi_k^t ] > 0$ for all $k \neq 0$ and $\xi_0^t = 0$ for all $t$
- **Assumption `r Aintragang_iid` (Independence):** $\mathbb{E} [ \xi_k^t \xi_{\ell}^t ] - \mathbb{E} [ \xi_k^t ] \mathbb{E}[ \xi_{\ell}^t ] = 0$ for all $k \neq \ell$

. . .

**Inter-Gang**

- $\epsilon_{k, \ell}^t$ - the probability a member of gang $k$ shoots a member of gang $\ell$
- **Assumption `r Aintergang_symmetry` (Quasi-symmetry):** $c_{k} \epsilon_{k, \ell}^t = c_{\ell} \epsilon_{\ell, k}^{t}$ with the normalization $c_1 = 1$. If $k = 0$ or $\ell = 0$ then $\epsilon_{k, \ell}^t = 0$ for all $t$
- **Assumption `r Aintergang_iid` (Independence):** $\mathbb{E} [ \epsilon_{k, \ell}^t \epsilon_{m, n}^t ] - \mathbb{E} [ \epsilon_{k, \ell}^t ] \mathbb{E} [ \epsilon_{m, n}^t ] = 0$ for $m, n \notin \left\{ k, \ell \right\}$

## Varieties of Violence

**Gang-Related Shootings**

$$
\mathbb{E} [ x_i^t ] = \underbrace{ \frac{m_{\pi(i)}}{n_{\pi(i)}} \mathbb{E} [ \xi_{\pi(i)}^t ]}_{ \text{intra-gang} } + \underbrace{\sum_{k \neq \pi(i)} \frac{m_k}{n_{\pi(i)}}  \mathbb{E} [ \epsilon_{k, \pi(i)}^t ]}_{ \text{inter-gang} }
$$

**Non-Gang Related Shootings**

$$
\mathbb{E} [y_i^t] = \eta_i r_i
$$
$$
\text{Var} [ y_i^t ] = \psi_i = \eta_i (1 - \eta_i) r_i
$$

## Covariance Structure

**Proposition `r Pcov`:** The covariance in shootings between districts $i$ and $j$ is
$$
a_{ij} = \begin{cases} \sum_{k \neq \pi(i)} \left( 
\left( \frac{m_k}{n_{\pi(i)}} \right)^2 \text{Var} [  \epsilon_{\pi(i), k}^t ] \right) +  \left( \frac{m_{\pi(i)}}{n_{\pi(i)}} \right)^2 \text{Var}[ \xi_{\pi(i)}^t ] + \psi_i & \text{if } i = j \\
\color{bcOrange} \sum_{k \neq \pi(i)} \left( 
\left( \frac{m_k}{n_{\pi(i)}} \right)^2 \text{Var} [ \epsilon_{\pi(i), k}^t ] \right) +  \left( \frac{m_{\pi(i)}}{n_{\pi(i)}} \right)^2 \text{Var} [ \xi_{\pi(i)}^t ] & \text{if } \pi(i) = \pi(j) \\
\color{bcOrange} \frac{m_{\pi(i)}}{n_{\pi(j)}} \frac{m_{\pi(j)}}{n_{\pi(i)}} \frac{c_{\pi(j)}}{c_{\pi(i)}} \text{Var} [\epsilon_{\pi(i), \pi(j)}^t] & \text{if } \pi(i) \neq \pi(j) \\
0 & \text{otherwise}
\end{cases}
$$

**Corollary `r Ccov` (Block Structure):** 

1. If $\pi(i) = \pi(j) = k$ and $i \neq j$ then $a_{ij} = b_{kk}$ constant for all $i, j$.
2. If $\pi(i) = k$ and $\pi(j) = \ell$ with $\ell \neq k$ then $a_{ij} = b_{k \ell}$ constant for all $i, j$.

## Covariance Structure

![](figs/block_mat.png)

. . .

$$
A_{N \times N} = (a_{ij})_{ \left\{ i,j \in \mathcal{N} \right\} }
$$

## Covariance Structure and Latent Variables

- $\Psi = \text{diag}(\psi_1, \dots \psi_N)$ (variance of non-gang shootings)
- $Q = A - \Psi$ (gang-related spatial covariance matrix)

. . .

- $B_{K + 1 \times K + 1} = (b_{k \ell})_{ \left\{ k, \ell \in \mathcal{K} \right\} }$ (within-gang variance and cross-gang covariances)
- $\Theta_{N \times K + 1} = (\theta_{ik})_{\left\{ i \in \mathcal{N}, k \in \mathcal{K} \cup 0 \right\} }$ (binary membership matrix, $\theta_{ik} = 1$ if $\pi(i) = k$ and $0$ otherwise)

. . .

$$
Q = \Theta B \Theta^T
$$

- Stochastic blockmodel [@Holland1983; @Jin2015; @Lei2015]

# Estimation

**Targets**

- Partition function, $\pi$ (membership matrix: $\Theta$)
- Number of groups $K$
- Non-gang territory, $\mathcal{N}_0$

**Method**

1. Hold $K$ fixed, estimate partition ($J = K + 1$)
2. Cross validate over many trial $K$ to estimate number of groups

## Estimation Problem

**Finite Sample Noise**

$$
\tilde{A} = \mathbb{E} [A] + \Phi
$$

- $\Phi = (\phi_{ij})_{ \left\{ i, j \in \mathcal{N} \right\} }$
- $\mathbb{E} [ \phi_{ij} ] = 0$ for all $i, j$

. . .

\begin{align*}
Q - \text{diag}(Q) &= \mathbb{E}[A] - \text{diag}(\mathbb{E}[A]) \\
&= \tilde{A} - \Phi - \text{diag}(\mathbb{E}[A]) \\
\Phi - \text{diag}(\Phi) &= \left( \tilde{A} - \text{diag}(\tilde{A}) \right) - \left( Q - \text{diag}(Q) \right)
\end{align*}

. . . 

**Moment Estimator**

\begin{equation} \label{eq:estimator}
(\hat{\Theta}, \hat{B}) = \argmin_{B \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J}} \lVert \Phi - \text{diag}(\Phi) \rVert_F
\end{equation}

## Eigenstructure of $Q$ (@Lei2015)

- $\Delta = \text{diag}(\sqrt{n_1}, \dots, \sqrt{n_{J}})$

\begin{align*}
Q &= \Theta B \Theta^T \\
&= \Theta \Delta^{-1} \Delta B \Delta \Delta^{-1} \Theta^T \\
&= \Theta \Delta^{-1} Z \Lambda Z^T \Delta^{-1} \Theta^T \\
&= \Theta X \Lambda X^T \Theta^T
\end{align*}

- $\Lambda = \text{diag}(\lambda_1, ..., \lambda_{J})$ nonzero eigenvalues of $\Delta B \Delta$
  - $Z_{N \times J}$ associated eigenvectors
- $X = \Delta^{-1} Z$

. . . 

**Spectral Clustering:** Relate eigenvectors of empirical covariance matrix $\tilde{A}$ to those of $Q$

$$
\tilde{A} - \text{diag}(\tilde{A}) = \tilde{U} \tilde{\Lambda} \tilde{U}^T
$$

## Modified Estimation Problem

\begin{align*}
\left( \hat{\Lambda}, \hat{X}, \hat{\Theta} \right) &= \argmin_{ \Lambda \in \mathbb{D}^{J \times J}, X \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J} } \lVert \Phi - \text{diag}(\Phi) \rVert_F \\
&= \argmin_{ \Lambda \in \mathbb{D}^{J \times J}, X \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J} } \lVert \left( \tilde{A} - \text{diag}(\tilde{A}) \right) - \left( Q - \text{diag}(Q) \right) \rVert_F \\
&= \argmin_{ \Lambda \in \mathbb{D}^{J \times J}, X \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J} } \lVert \tilde{U} \tilde{\Lambda} \tilde{U}^T - \left( \Theta X \Lambda X^T \Theta^T - \text{diag}(Q) \right) \rVert_F \\
&\approx \argmin_{ \Lambda \in \mathbb{D}^{J \times J}, X \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J} } \lVert \color{bcOrange} \tilde{U} \color{black} \tilde{\Lambda} \color{bcOrange} \tilde{U}^T \color{black} - \color{bcOrange} \Theta X \color{black} \Lambda \color{bcOrange} \left( \Theta X \right)^T \color{black} \rVert_F
\end{align*}

- Set $\hat{\Lambda} = \tilde{\Lambda}$

. . .

\begin{equation} \label{eq:kmeans}
\left( \hat{X}, \hat{\Theta} \right) = \argmin_{ X \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J} } \lVert \color{bcOrange} \Theta X - \tilde{U} \color{black} \rVert_F
\end{equation}

- K-means problem

. . .

**Inter-Gang Conflict Estimates**

\begin{equation} \label{eq:B}
\hat{B} = \hat{X} \hat{\Lambda} \hat{X}^T
\end{equation}

## Non-Gang Territory

- No covariance with gang territory in expectation, 
  + $\mathbb{E} [ b_{0k} ] = 0$ for all $k \neq 0$

**Estimator**

\begin{equation} \label{eq:nc}
\min_{ k \in \left\{ 1, ..., J \right\} } \lVert ( \hat{B} - \text{diag}(\hat{B}) )^{(k)} \rVert_2
\end{equation}

## Number of Groups [@Chen2018]

1. For each $k \in \left\{ 1, ..., \bar{K} \right\}$,
    + Randomly split districts into folds $\mathcal{N}_1, \dots, \mathcal{N}_V$.
    + For each fold, estimate $\hat{\Theta}(v)$ and $\hat{B}(v)$.
    + For each fold, calculate the predictive loss on $\tilde{A}^{(v,v)}$, $L_v(\tilde{A}, \hat{A}(v))$
    + Average the predictive loss across folds, $\bar{L}_{k}(\tilde{A})$.
2. Construct the sequence of changes in predictive loss, $\delta$.
3. Select $\hat{J}$ at first point in sequence where predictive loss does not decrease

# Results

- `r K` gangs detected

<!-- ```{r scree, echo=FALSE, warning=FALSE, message=FALSE, fig.height=4.5, dpi=300}

screePlot

``` -->

## Empirical Covariances

<!-- ```{r emp_cov, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5.5, dpi=300}

block_hm

``` -->

## Territorial Partition

<!-- ```{r partition, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5.5, dpi=300}

chi_clusters_map

``` -->

## Conflict Intensities

<!-- ```{r b_hat, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5.5, dpi=300}

Bhat_hm

``` -->

# Next Steps

- Validation
  + Calculate empirical loss relative to Chicago gang map
- Uncertainty
  + Bootstrap tract-months, calculate confidence metrics for partition function, intervals for number of groups
- Robustness
  + Different levels of resolution, block groups? 
- Extend to other cities

# Thank You  {.aligncenter}

# Changes in Territory over Time {id="bruhn_maps"}

<center>
![](figs/Bruhn_maps.png){width=65%}
</center>

<hr style="height:30em; visibility:hidden;" />

- @Bruhn2019, <a href="#/data">Back</a>

