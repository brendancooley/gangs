---
title: "Gunshots and Turf Wars:"
subtitle: Inferring Gang Territories from Administrative Data
date: "24 March 2020"
author: Brendan Cooley | Noam Reich
position: Ph.D. Candidates
institution: Princeton University
email: "bcooley (at) princeton.edu | noamg (at) princeton.edu"

bibliography: /Users/brendancooley/Dropbox (Princeton)/References/library.bib
biblio-style: apsr

backgroundTitle: "other/chi_aerial.jpg"

output:
  revealjs::revealjs_presentation:
    template: "css/cooley-reveal.html"
    css: "css/cooley-reveal.css"
    backgroundTransition: none
    transition: none
    self_contained: false
    # reveal_plugins: ["notes"]
    lib_dir: index_files
    fig_caption: true
    reveal_options:
      slideNumber: false
      progress: false
      controls: true
---


```{r references, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}

if (file.exists('references.RData')) load('references.RData')

```

```{r, child = "07_slides/introduction.rmd"}
```

```{r, child = "07_slides/data.rmd"}
```

```{r, child = "07_slides/model.rmd"}
```

# Old



# Estimation

**Targets**

- Partition function, $\pi$ (membership matrix: $\Theta$)
- Number of groups $K$
- Non-gang territory, $\mathcal{N}_0$

**Method**

1. Hold $K$ fixed, estimate partition ($J = K + 1$)
2. Cross validate over many trial $K$ to estimate number of groups

## Estimation Problem

**Finite Sample Noise**

$$
\tilde{A} = \mathbb{E} [A] + \Phi
$$

- $\Phi = (\phi_{ij})_{ \left\{ i, j \in \mathcal{N} \right\} }$
- $\mathbb{E} [ \phi_{ij} ] = 0$ for all $i, j$

. . .

\begin{align*}
Q - \text{diag}(Q) &= \mathbb{E}[A] - \text{diag}(\mathbb{E}[A]) \\
&= \tilde{A} - \Phi - \text{diag}(\mathbb{E}[A]) \\
\Phi - \text{diag}(\Phi) &= \left( \tilde{A} - \text{diag}(\tilde{A}) \right) - \left( Q - \text{diag}(Q) \right)
\end{align*}

. . . 

**Moment Estimator**

\begin{equation} \label{eq:estimator}
(\hat{\Theta}, \hat{B}) = \argmin_{B \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J}} \lVert \Phi - \text{diag}(\Phi) \rVert_F
\end{equation}

## Eigenstructure of $Q$ (@Lei2015)

- $\Delta = \text{diag}(\sqrt{n_1}, \dots, \sqrt{n_{J}})$

\begin{align*}
Q &= \Theta B \Theta^T \\
&= \Theta \Delta^{-1} \Delta B \Delta \Delta^{-1} \Theta^T \\
&= \Theta \Delta^{-1} Z \Lambda Z^T \Delta^{-1} \Theta^T \\
&= \Theta X \Lambda X^T \Theta^T
\end{align*}

- $\Lambda = \text{diag}(\lambda_1, ..., \lambda_{J})$ nonzero eigenvalues of $\Delta B \Delta$
  - $Z_{N \times J}$ associated eigenvectors
- $X = \Delta^{-1} Z$

. . . 

**Spectral Clustering:** Relate eigenvectors of empirical covariance matrix $\tilde{A}$ to those of $Q$

$$
\tilde{A} - \text{diag}(\tilde{A}) = \tilde{U} \tilde{\Lambda} \tilde{U}^T
$$

## Modified Estimation Problem

\begin{align*}
\left( \hat{\Lambda}, \hat{X}, \hat{\Theta} \right) &= \argmin_{ \Lambda \in \mathbb{D}^{J \times J}, X \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J} } \lVert \Phi - \text{diag}(\Phi) \rVert_F \\
&= \argmin_{ \Lambda \in \mathbb{D}^{J \times J}, X \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J} } \lVert \left( \tilde{A} - \text{diag}(\tilde{A}) \right) - \left( Q - \text{diag}(Q) \right) \rVert_F \\
&= \argmin_{ \Lambda \in \mathbb{D}^{J \times J}, X \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J} } \lVert \tilde{U} \tilde{\Lambda} \tilde{U}^T - \left( \Theta X \Lambda X^T \Theta^T - \text{diag}(Q) \right) \rVert_F \\
&\approx \argmin_{ \Lambda \in \mathbb{D}^{J \times J}, X \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J} } \lVert \color{bcOrange} \tilde{U} \color{black} \tilde{\Lambda} \color{bcOrange} \tilde{U}^T \color{black} - \color{bcOrange} \Theta X \color{black} \Lambda \color{bcOrange} \left( \Theta X \right)^T \color{black} \rVert_F
\end{align*}

- Set $\hat{\Lambda} = \tilde{\Lambda}$

. . .

\begin{equation} \label{eq:kmeans}
\left( \hat{X}, \hat{\Theta} \right) = \argmin_{ X \in \mathbb{R}^{J \times J}, \Theta \in \mathbb{M}^{N \times J} } \lVert \color{bcOrange} \Theta X - \tilde{U} \color{black} \rVert_F
\end{equation}

- K-means problem

. . .

**Inter-Gang Conflict Estimates**

\begin{equation} \label{eq:B}
\hat{B} = \hat{X} \hat{\Lambda} \hat{X}^T
\end{equation}

## Non-Gang Territory

- No covariance with gang territory in expectation, 
  + $\mathbb{E} [ b_{0k} ] = 0$ for all $k \neq 0$

**Estimator**

\begin{equation} \label{eq:nc}
\min_{ k \in \left\{ 1, ..., J \right\} } \lVert ( \hat{B} - \text{diag}(\hat{B}) )^{(k)} \rVert_2
\end{equation}

## Number of Groups [@Chen2018]

1. For each $k \in \left\{ 1, ..., \bar{K} \right\}$,
    + Randomly split districts into folds $\mathcal{N}_1, \dots, \mathcal{N}_V$.
    + For each fold, estimate $\hat{\Theta}(v)$ and $\hat{B}(v)$.
    + For each fold, calculate the predictive loss on $\tilde{A}^{(v,v)}$, $L_v(\tilde{A}, \hat{A}(v))$
    + Average the predictive loss across folds, $\bar{L}_{k}(\tilde{A})$.
2. Construct the sequence of changes in predictive loss, $\delta$.
3. Select $\hat{J}$ at first point in sequence where predictive loss does not decrease

# Results

- `r K` gangs detected

<!-- ```{r scree, echo=FALSE, warning=FALSE, message=FALSE, fig.height=4.5, dpi=300}

screePlot

``` -->

## Empirical Covariances

<!-- ```{r emp_cov, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5.5, dpi=300}

block_hm

``` -->

## Territorial Partition

<!-- ```{r partition, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5.5, dpi=300}

chi_clusters_map

``` -->

## Conflict Intensities

<!-- ```{r b_hat, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5.5, dpi=300}

Bhat_hm

``` -->

# Next Steps

- Validation
  + Calculate empirical loss relative to Chicago gang map
- Uncertainty
  + Bootstrap tract-months, calculate confidence metrics for partition function, intervals for number of groups
- Robustness
  + Different levels of resolution, block groups? 
- Extend to other cities

# Thank You  {.aligncenter}

# Changes in Territory over Time {id="bruhn_maps"}

<center>
![](figs/Bruhn_maps.png){width=65%}
</center>

<hr style="height:30em; visibility:hidden;" />

- @Bruhn2019, <a href="#/data">Back</a>

