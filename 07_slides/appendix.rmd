```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}

libs <- c("stringi", "patchwork")
ipak(libs)

label_counts <- read_csv(label_counts_path) %>% filter(owner != "peaceful") %>% arrange(desc(count))
label_counts$count <- label_counts$count / L
colnames(label_counts) <- c("Gang", "Proportion")
label_counts$Gang <- stri_trans_totitle(label_counts$Gang)

```

## Territorial Distribution {id="turf_distribution"}

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=4, dpi=300}

source("../05_figs/chi_gang_areas.R")
gang_area_plot

``` 

<a href="#/data">Back (Data)</a>

<a href="#/toc">Back (TOC)</a>

## Gang Boundaries and Neighborhood Ethnicity {id="ethnicity"}

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=4, dpi=300}

source("../05_figs/ethnicity.R")
tmap_arrange(chi_turf_binary_map, ethnicity_map)

``` 

<a href="#/data">Back (Data)</a>

<a href="#/toc">Back (TOC)</a>

## Number of Groups (I) {id="chen"}

- Rectangular subset of $\tilde{A}$, $\tilde{A}^{(-v, v)} = \tilde{A}^{(\mathcal{N}_{-v}, \mathcal{N})}$
- Theoretical analogue
$$
Q^{(-v, v)} = \Theta^{(-v, v)} B \Theta
$$
- Eigenstructure of $\left( Q^{(-v, v)} \right)^T Q$
\begin{align*}
\left( Q^{(-v, v)} \right)^T Q &= \Theta B^T \left( \Theta^{(-v, v)} \right)^T \Theta^{(-v, v)} B \Theta^T \\
&= \Theta B^T \left( \Delta^{(-v, -v)} \right)^2 B \Theta^T .
\end{align*}
- Eigendecompose using right singular values of $Q^{(-v, v)}$ and k-means cluster to produce membership estimates $\hat{\Theta}(v)$

## Number of Groups (II)

- Estimate connectivity matrix
$$
\hat{B}_{k, \ell} = \begin{cases}
\frac{ \sum_{i \in \hat{\mathcal{N}}_{-v, k}, j \in \hat{\mathcal{N}}_{\ell} } \tilde{A}_{ij} }{ \hat{n}_{v, k} \hat{n}_{\ell}} & \text{if } k \neq \ell \\
\frac{ \sum_{i, j \in \hat{\mathcal{N}}_{-v, k}, i \neq j} A_{ij} + \sum_{i \in \hat{\mathcal{N}}_{-v, k}, j \in \hat{\mathcal{N}}_{v, k} } A_{ij} }{ (\hat{n}_{-v, k} - 1) \hat{n}_{-v, k} + \hat{n}_{-v, k} \hat{n}_{v, k} } & \text{if } k = \ell
\end{cases}
$$
- Construct implied covariance matrix 
$$
\hat{A}(v) = \hat{\Theta}(v) \hat{B}(v) \left( \hat{\Theta}(v) \right)^T
$$
- Calculate loss
$$
L_v(\tilde{A}, \hat{A}(v)) = \left\lVert \left( \tilde{A}^{(v,v)} - \text{diag}(\tilde{A}^{(v,v)}) \right) - \left( \hat{A}(v)^{(v,v)} - \text{diag}(\hat{A}(v)^{(v,v)}) \right) \right\rVert_F
$$

<a href="#/J_estimation">Back (Estimation)</a>

<a href="#/toc">Back (TOC)</a>

## Eigengaps {id="eigengaps"}

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=4, dpi=300}

source("../05_figs/scree.R")
screePlot

```

<a href="#/results">Back (Results)</a>

<a href="#/toc">Back (TOC)</a>

## Match Frequencies {id="cpd_match_table"}

![](05_figs/chicago/matched_gang_counts.png)

<a href="#/results">Back (Results)</a>

<a href="#/toc">Back (TOC)</a>