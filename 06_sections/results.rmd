```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}

source("../01_code/00_params.R")
libs <- c("knitr", "kableExtra", "stringi")
ipak(libs)

J <- read_csv(J_path, col_names=FALSE) %>% pull(.)
K <- J - 1

J_all <- read_csv(J_all_path, col_names=FALSE) %>% pull(.)
K_all <- J_all - 1
K_all <- K_all %>% sort()

K_lower <- K_all[3]
K_upper <- K_all[97]

label_counts <- read_csv(label_counts_path) %>% filter(owner != "peaceful") %>% arrange(desc(count))
label_counts$count <- label_counts$count / L
colnames(label_counts) <- c("Gang", "Proportion")
label_counts$Gang <- stri_trans_totitle(label_counts$Gang)

```

The data cleaning procedure discussed above produces a $N \times T$ matrix of homicide and non-fatal shooting counts for each census tract-month. We construct the covariance matrix $A$ from the rows of this matrix, where each entry $a_{ij}$ stores the covariance in shootings between census tracts $i$ and $j$ over our sample period.^[Some districts experience no shootings over the sample period. We exclude these from the estimation and assign them to the peaceful cluster ex-post.] To quantify the uncertainty surrounding our estimates, we sample the set of homicides with replacement `r L` times, reconstruct the count and covariance matrices, and re-run our estimators on the bootstrapped data. This produces sets of bootstrapped estimates of the number of gangs $K$ and associated territorial partitions, $\Theta$. For purposes of validation, we match each of these bootstrapped estimates to the CPD classifications by permuting their cluster labels to most-closely match those of the CPD. This procedure allows for the possibility that different bootstrap iterations return different sets of matched gangs.^[The procedure also leaves open the possibility that we disagree with the CPD on the identity of the non-gang cluster. In practice, we agree on this quantity in all bootstrap iterations.] For presentational purposes, we aggregate our census tract labels and conflict intensity estimates at the matched-gang level, meaning that the set of gangs for which we assign territory in *some* bootstrap iteration is larger than any bootstrapped estimate for the number of gangs. Uncertainty intervals presented below correspond to 95 percent confidence intervals unless otherwise noted.

```{r, echo=FALSE, warning=FALSE, message=FALSE}

kable(label_counts, "latex", booktabs=T, caption="Matched-Gang Counts \\label{tab:label_counts}") %>%
	kable_styling(latex_options = c("striped"))

```

We detect the presence of `r K_lower`-`r K_upper` gangs in Chicago. Table \ref{tab:label_counts} reports the frequency with which each gang is included in the analysis. Following @Ahn2013, we plot the intervals around the leading eigenvalues of the bootstrapped covariance matrices in Figure \ref{fig:scree}. The first several eigenvalues tend to stand out from the remainder, indicative of the presence of unique clusters of gang activity in the data.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap = paste0("Leading eigenvalues of the matrix of covariances in shootings across districs. Dashed line is drawn between the average values of the ", K_lower + 1, "th and ",  K_upper + 1, "th eigenvalues, consistent with our estimates for the number of clusters. Eigenvectors associated with first $J$ eigenvalues are used to estimate the territorial partition. \\label{fig:scree}"), fig.height=4, dpi=300, fig.pos="t"}

source("../05_figs/scree.R")
screePlot

```

These clusters are easily visualized by examining the permuted covariance matrix, the empirical analogue to Figure \ref{fig:blocks}. The right-hand panel of Figure \ref{fig:block_hm} displays the permutation consistent baseline estimated territorial partition, in which `r K` gangs were detected. This matrix is constructed by taking raw covariance matrix (left) and permuting the rows and columns to correspond with the estimated partition. Each square on the right panel highlights the districts controlled with a single gang, with the bottom right block corresponding to districts estimated to have no gang activity. Gang wars generate positive covariance in the off-block diagonal entries. Darker off-block-diagonal entries indicate more intense conflict between the gangs controlling the pairs of districts in question. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap = "The left-hand panel shows the values of the unclustered spatial covariance matrix (baseline). Darker values indicate higher tract-to-tract covariance in shootings. The right-hand panel permutes these entries in accordance with the estimated partition function. The black squares highlight covariances within a given gang's territory (produced by intra-gang conflict). The bottom right block corresponds to the districts estimated to have no gang activity. \\label{fig:block_hm}", fig.height=4, dpi=300, fig.pos="t"}

source("../05_figs/P.R")
block_hm

```

**STOPPING POINT***

Figure \ref{fig:map} shows the distribution of gang territory in the Chicago. Like the distribution of shootings, gang activity is concentrated in the south and west of the city. Large tracts of the central and northern parts of the city are estimated to be devoid of gang activity. Gangs territories are somewhat locally compact, consistent with data published by the Chicago Police. However, some neighborhoods of the city are quite contested. All of the gangs we detect operate in both the southern and western of the city.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap = paste0("Estimated territorial partition of Chicago, ", bruhn_sy, "-", bruhn_ey, ". Light gray tracts are estimated to have no gang activity. \\label{fig:map}"), fig.height=9, dpi=300, fig.pos="t"}

source("../05_figs/clusters.R")
chi_clusters_map

```

So far, we have focused on our results for the esimated partition function, $\hat{\pi}$. Our estimates for $\hat{B}$ describe the intensity of conflict between gangs in our sample. Figure \ref{fig:Bhat_hm} displays the magnitudes of these conflict intensities. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap = "Estimated inter-gang conflict intensities, $\\hat{B}$, exempting non-gang occupied areas. Colors along the diagonal correspond to the gangs occupying the territories shown in Figure \\ref{fig:map}. Darker grays indicate the corresponding gangs on the diagonal tend to experience more intense conflict with one another. \\label{fig:Bhat_hm}", fig.height=4, dpi=300, fig.pos="t"}

source("../05_figs/Bhat.R")
Bhat_hm

```
