```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}

source("../01_code/00_params.R")
libs <- c("knitr", "kableExtra", "stringi", "patchwork")
ipak(libs)

J <- read_csv(J_path, col_names=FALSE) %>% pull(.)
K <- J - 1

J_all <- read_csv(J_all_path, col_names=FALSE) %>% pull(.)
K_all <- J_all - 1
K_all <- K_all %>% sort()

K_lower <- K_all[3]
K_upper <- K_all[97]

label_counts <- read_csv(label_counts_path) %>% filter(owner != "peaceful") %>% arrange(desc(count))
label_counts$count <- label_counts$count / L
colnames(label_counts) <- c("Gang", "Proportion")
label_counts$Gang <- stri_trans_totitle(label_counts$Gang)

LK_freq <- label_counts %>% filter(Gang=="Latin Kings") %>% pull(Proportion)
TS_freq <- label_counts %>% filter(Gang=="Two-Six") %>% pull(Proportion)

gang_frac_vec <- read_csv(gang_frac_path, col_names=FALSE) %>% pull()
gang_frac_ci <- quantile(gang_frac_vec, c(.025, .975))

sample_agreement_ratio <- read_csv(sample_agreement_ratio_path, col_names=FALSE) %>% pull()
cpd_agreement_ratio <- read_csv(cpd_agreement_ratio_path, col_names=FALSE) %>% pull()
cpd_agreement_ratio_peaceful <- read_csv(cpd_agreement_ratio_peaceful_path, col_names=FALSE) %>% pull()
cpd_agreement_ratio_gang <- read_csv(cpd_agreement_ratio_gang_path, col_names=FALSE) %>% pull()

cpd_agreement_ratio_ci <- quantile(cpd_agreement_ratio, c(.025, .975))
cpd_agreement_ratio_peaceful_ci <- quantile(cpd_agreement_ratio_peaceful, c(.025, .975))
cpd_agreement_ratio_gang_ci <- quantile(cpd_agreement_ratio_gang, c(.025, .975))

```

The data cleaning procedure discussed above produces a $N \times T$ matrix of homicide and non-fatal shooting counts for each census tract-month. We construct the covariance matrix $A$ from the rows of this matrix, where each entry $a_{ij}$ stores the covariance in shootings between census tracts $i$ and $j$ over our sample period.^[Some districts experience no shootings over the sample period. We exclude these from the estimation and assign them to the peaceful cluster ex-post.] To quantify the uncertainty surrounding our estimates, we sample the set of homicides with replacement `r L` times, reconstruct the count and covariance matrices, and re-run our estimators on the bootstrapped data. This produces sets of bootstrapped estimates for the number of gangs $K$ and associated territorial partitions, $\Theta$. To validate model output, we match each of these bootstrapped estimates to the CPD classifications by permuting their cluster labels to most-closely match those of the CPD. This procedure allows for the possibility that different bootstrap iterations return different sets of matched gangs.^[The procedure also leaves open the possibility that we disagree with the CPD on the identity of the non-gang cluster. In practice, we agree on this quantity in all bootstrap iterations.] For presentational purposes, we aggregate our census tract labels and conflict intensity estimates at the matched-gang level, meaning that the set of gangs for which we assign territory in *some* bootstrap iteration is larger than any bootstrapped estimate for the number of gangs. Uncertainty intervals presented below correspond to 95 percent confidence intervals unless otherwise noted.

```{r, echo=FALSE, warning=FALSE, message=FALSE}

kable(label_counts, "latex", booktabs=T, caption="Matched-Gang Counts \\label{tab:label_counts}") %>%
	kable_styling(latex_options = c("striped"))

```

We detect the presence of `r K_lower`-`r K_upper` gangs in Chicago. Table \ref{tab:label_counts} reports the frequency with which each CPD-tagged gang is included in the analysis. Following @Ahn2013, we plot the intervals around the leading eigenvalues of the bootstrapped covariance matrices in Figure \ref{fig:scree}. The first several eigenvalues tend to stand out from the remainder, indicative of the presence of unique clusters of gang activity in the data.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap = paste0("Leading eigenvalues of the matrix of covariances in shootings across districs. Dashed line is drawn between the average values of the ", K_lower + 1, "th and ",  K_upper + 1, "th eigenvalues, consistent with our estimates for the number of clusters. Eigenvectors associated with first $J$ eigenvalues are used to estimate the territorial partition. \\label{fig:scree}"), fig.height=4, dpi=300, fig.pos="t"}

source("../05_figs/scree.R")
screePlot

```

These clusters are easily visualized by examining the permuted covariance matrix, the empirical analogue to Figure \ref{fig:blocks}. The right-hand panel of Figure \ref{fig:block_hm} displays the permutation consistent with baseline estimated territorial partition, in which `r K` gangs were detected. This matrix is constructed by taking raw covariance matrix (left) and permuting the rows and columns to correspond with the estimated partition. Each square on the right panel highlights the districts controlled with a single gang, with the bottom right block corresponding to districts estimated to have no gang activity. Gang wars generate positive covariance in the off-block diagonal entries. Darker off-block-diagonal entries indicate more intense conflict between the gangs controlling the pairs of districts in question. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap = "The left-hand panel shows the values of the unclustered spatial covariance matrix (baseline). Darker values indicate higher tract-to-tract covariance in shootings. The right-hand panel permutes these entries in accordance with the estimated partition function. The black squares highlight covariances within a given gang's territory (produced by intra-gang conflict). The bottom right block corresponds to the districts estimated to have no gang activity. \\label{fig:block_hm}", fig.height=4, dpi=300, fig.pos="t"}

source("../05_figs/P.R")
block_hm

```

Figure \ref{fig:comparison_map} plots the spatial distribution of estimated gang territory in Chicago (with CPD-reported territories side-by-side for purposes of comparison). Colors indicate which CPD-tagged gang the tract was matched to in the majority of bootstrap iterations. Shading indicates the fraction of iterations for which the tract was matched to a given gang. The estimated peaceful cluster is shown in white to highlight gang turf. We estimate `r round(gang_frac_ci[1]*100, 0)`-`r round(gang_frac_ci[2]*100, 0)` percent of the city's census tracts to be gang-occupied. We locate gang activity predominently in the city's West Side and South Side neighborhoods, consistent with CPD assessments. Downtown and North Side neighborhoods are estimated to be free from gang activity in nearly every bootstrap iteration. Like the CPD maps, our estimated gang territories are highly non-convex. 

We confidently assign much of Chicago's West Side to a cluster that mirrors the territory of the Vice Lords (Red). Like the CPD, however, we also detect Vice Lord activity in the city's South Side. These neighborhoods are estimated to be dominated by a gang whose turf approximates that of the Gangster Disciples (Blue). A third cluster interspersed through Gangster Disciple territory also appears frequently, which our matching exercises assigns to the Black P Stones (Purple). Consistent with CPD reports, both of these groups operate in the city's West Side and Uptown neighborhoods. In general, we assign tracts to gangs with less confidence in the South Side. This may be because turf in this area is more contested and fluid than in the West Side [@Bruhn2019]. The CPD reports that all of these gangs have a black identity and our gang turf estimates overlap most frequently with the city's black neighborhoods (see Figure TKTK).

We detect clusters that match to Latino gang turf less frequently. We detect a cluster approximating the turf of the Latin Kings in `r round(LK_freq*100, 1)` percent of bootstrap iterations and a cluster mirroring the turf of Two-Six in `r round(TS_freq*100, 1)` percent of iterations.

Overall, our tract labels agree with those of the CPD in `r round(cpd_agreement_ratio_ci[1]*100, 0)`-`r round(cpd_agreement_ratio_ci[2]*100, 0)` percent of cases. Randomly permuting the CPD's labels produces agreement in only `r round(sample_agreement_ratio*100, 0)` percent of cases. The agreement ratio is highest among peaceful tracts. For tracts we classify as peaceful, the CPD also reports an absence of gang activity `r round(cpd_agreement_ratio_peaceful_ci[1]*100, 0)`-`r round(cpd_agreement_ratio_peaceful_ci[2]*100, 0)` percent of the time. Among tracts we assign to some gang, our labels agree with those of the CPD in `r round(cpd_agreement_ratio_gang_ci[1]*100, 0)`-`r round(cpd_agreement_ratio_gang_ci[2]*100, 0)` percent of cases. This low rate of agreement in this class of tracts is due to two factors. First, both our estimates and those of the CPD classify the vast majority of districts as peaceful. Any subset of the labels is therefore likely to find a large number of peaceful labels in the comparison set. Second, because our estimates for the number of gangs are substantially smaller than the number of gangs the CPD reports, we can only match our labels to a small subset of CPD-reported gangs. Figure \ref{fig:comparison_map} confirms that we capture the distribution of gang activity qualitatively quite well, despite this disagreement. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap = paste0("Left: CPD-reported gang territories, ", bruhn_sy, "-", bruhn_ey, ". Right: Estimated clusters matched to CPD labels. Shading indicates fraction of bootstrap iterations for which tract was assigned to given cluster. White indicates the absence of gang-activity (peaceful cluster). \\label{fig:comparison_map}"), fig.height=9, dpi=300, fig.pos="t"}

source("../05_figs/clusters.R")
comparison_maps

```

So far, we have focused on our results on the estimated partition function, $\hat{\pi}$. Our estimates for $\hat{B}$ describe the intensity of conflict between gangs in our sample. Figure \ref{fig:Bhat_hm} displays the magnitudes of these conflict intensities and Figure \ref{fig:Bhat_ci} plots uncertainty intervals around these point estimates. Some care is warranted in interpreting these results. These estimates correspond to the theoretical quantities defined in Corollary `r Ccov`. Diagonal entries of this matrix ($b_{kk}$) correspond to the sum of the scaled variance of internal conflict shocks and all scaled inter-gang shocks, where the scaling reflects the size (in membership) of each gang relative to the size of the territory it occupies. This encompasses a larger set of variation than off-diagonal entries, so diagonal entries tend to be larger than off-diagonal entries. Off diagonal entries ($b_{k \ell}$) reflect the size of the inter-gang conflict shocks, scaled by the relative size of the gangs in conflict. Larger values of $b_{k \ell}$ indicate the gangs experience higher-variance conflict shocks, or that the groups are relatively large. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap = "Estimated inter-gang conflict intensities, $\\hat{B}$, exempting non-gang occupied areas. Darker colors indicate the corresponding gangs on tend to experience more intense conflict with one another. \\label{fig:Bhat_hm}", fig.height=4, dpi=300, fig.pos="t"}

source("../05_figs/Bhat.R")
Bhat_hm

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap = "Estimated inter-gang conflict intensities, confidence intervals. \\label{fig:Bhat_ci}", fig.height=4, dpi=300, fig.pos="t"}

source("../05_figs/Bhat.R")
Bhat_ci

```

Relative to the Black P Stones and Gangster Disciples, the Vice Lords' diagonal intensity is quite large. Given that the Vice Lords do not appear to experience larger inter-gang conflict intensity than their peers, this may suggest that they experience relatively large internal conflict shocks. This observation is consistent with the gang's reportedly fragmented organizational structure [@Bruhn2019].^[@Papachristos2009 recounts a war between gangs of the Almighty Vice Lord Nation (AVLN), whose members we aggregate into a single unit for purposes of the present analysis.] Unfortunately, as demonstrated in Figure \ref{fig:Bhat_ci}, inter-gang conflict intensity estimates do not come with statistical precision necessary to make claims about patterns of gang alliance and conflict. We are also unable to estimate the relative size of gang membership given the sparse assumptions of our model. While we get estimates for $n_{k}$, the number of tracts gang $k$ owns, from the partition function, the size of $k$'s membership is not separately identified from the variance of internal conflict shocks. This agnosticism preserves miminalism in the set of asssumptions we adopt while retaining the ability to estimate the number of groups in operation and the territorial partition, the objects of primary interest for this study.
