In this section we derive our estimand from a model of the data generating process for violence. We do so by distinguishing between different types of violence and calculating the corresponding spatial covariance in violence. Our assumptions are minimal. We take as primitives the probability that individuals engage in violence against one another and take no stance on the strategic processes generating these probabilities.

## Primitives and Assumptions

There are $N$ districts in the city ($i, j \in \mathcal{N} = \left\{1, ..., N \right\}$) each of which has $r_i$ residents. The city is also inhabited by $K$ gangs ($k, \ell \in \mathcal{K} = \left\{1, ..., K \right\}$) each endowed with $m_k$ soldiers. A partition function $\pi : \mathcal{N} \rightarrow \left\{ 0, \mathcal{K} \right\}$ assigns districts to the gangs that control them, where $\pi(i) = 0$ indicates the absence of any gang activity. $\mathcal{N}_k$ is the set of districts controlled by gang $k$ and $n_k = | \mathcal{N}_k |$ the number of districts controlled by gang $k$. The set of unoccupied districts is $\mathcal{N}_0$. We are interested in estimating the number of groups, $K$, and the territorial partition, $\pi$.

We observe data on geo-located shootings for $T$ periods, indexed $\left\{ 1, ..., T \right\}$. There are three types of shootings that occur in the city -- inter-gang, intra-gang, and non-gang. Let $y_i^t$ denote non-gang shootings in district $i$ during period $t$ and $x_i^t$ denote gang-related shootings in the same district-period. Non-gang shootings are committed by residents with probability $\eta_i$ and are independent across districts. Then, the expected number of shootings in district $i$ is $\eta_i r_i$ with variance $\psi_i = \eta_i (1 - \eta_i) r_i$.^[In other words, non-gang shootings are distributed i.i.d. binomial.]
  
Gang-related shootings are determined by the geographic distribution of gang activity and the state of relations between and within gangs. Members of the same gang sometimes commit violence against one another. The probability a member of gang $k$ shoots a member of his own gang during period $t$ is given by $\xi_k^t$. Assumption `r Aintragang_nz` states that the expected likelihood of such violence is non-zero.

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
Aintragang_nz <- Atick
Atick <- Atick + 1
```

**Assumption `r Aintragang_nz`:** $\E [ \xi_k^t ] > 0$ for all $k \neq 0$ and $\xi_0^t = 0$ for all $t$.

We also assume that conflict within gangs is unrelated to within-gang conflict between other gangs.

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
Aintragang_iid <- Atick
Atick <- Atick + 1
```

**Assumption `r Aintragang_iid`:** $\E [ \xi_k^t \xi_{\ell}^t ] - \E [ \xi_k^t ] \E [ \xi_{\ell}^t ] = 0$ for all $k \neq \ell$.

We impose no other restrictions on the distribution of intra-gang shocks. The possibility of intra-gang violence allows us to distinguish between districts owned by the same gang and districts whose owners exclusively war with one another.^[Alternatively, we could assume that gangs fight at least two other groups with positive probability. We view this assumption as less restrictive and more attuned to the data as our results suggest that there is a significant amount of intra-gang violence.]  

Gangs also war with one another with varying intensity. The probability a member of gang $k$ shoots a member of gang $\ell$ during period $t$ is $\epsilon_{k \ell}^t$. We make two assumptions on the distribution of these inter-gang shocks. First, we assume they are quasi-symmetric. This requires that any increase in the likelihood that members of gang $k$ shoot members of gang $\ell$ is accompanied by a proportionate increase in reciprocal violence. Notably, we allow this retaliation propensity to vary at the level of the gang but not the gang-dyad. Second, we assume that shocks between all gangs and unoccupied territory are zero, consistent with the absence of gang activity in these geographic units.

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
Aintergang_symmetry <- Atick
Atick <- Atick + 1
```

**Assumption `r Aintergang_symmetry`:** $c_{k} \epsilon_{k, \ell}^t = c_{\ell} \epsilon_{\ell, k}^{t}$ with the normalization $c_1 = 1$. If $k = 0$ or $\ell = 0$ then $\epsilon_{k, \ell}^t = 0$ for all $t$.

Second, we assume inter-gang shocks are independent across gang dyads.^[Of course, the intensity of conflict between any two gangs is almost certainly affected by the broader conflict environment. This assumption is made for purposes of model tractability. In future work, we plan to model the genesis of conflict shocks and perhaps relax this assumption.]

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
Aintergang_iid <- Atick
Atick <- Atick + 1
```

**Assumption `r Aintergang_iid`:** $\E \left[ \epsilon_{k, \ell}^t \epsilon_{m, n}^t \right] - \E \left[ \epsilon_{k, \ell}^t  \right] \E \left[ \epsilon_{m, n}^t \right] = 0$ for $m, n \notin \left\{ k, \ell \right\}$.

We assume the probability a given soldier from gang $k$ is operating in territory $i$ is constant and given by $n_k^{-1}$. This assumption implies that intra-gang violence should be equally distributed throughout its territory. Similarly inter-gang violence should be equally distributed across both gangs' territory. The expected number of gang-related shootings in district $i$ during period $t$ can then be calculated as 
$$
\E [ x_i^t ] = \underbrace{ \frac{m_{\pi(i)}}{n_{\pi(i)}} \E [ \xi_{\pi(i)}^t ]}_{ \text{intra-gang} } + \underbrace{\sum_{k \neq \pi(i)} \frac{m_{\pi(i)}}{n_{\pi(i)}}  \E [ \epsilon_{k, \pi(i)}^t ]}_{ \text{inter-gang} }
$$
The total number of shootings in district $i$ during period $t$ is
$$
v_i^t = x_i^t + y_i^t
$$

## Covariance Structure

We can use the model described above to derive a covariance structure in shootings. Let $a_{ij} = \Cov [ v_i^t, v_j^t ]$ denote the covariance in violence between territories $i$ and $j$. Proposition `r Pcov` describes the $a_{ij}$.^[A derivation can be found in Appendix `r Apdx_cov`.]

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
Pcov <- Ptick
Ptick <- Ptick + 1
```

**Proposition `r Pcov`:** The covariance in shootings between districts $i$ and $j$ is
$$
a_{ij} = \begin{cases} \sum_{k \neq \pi(i)} \left( 
\left( \frac{m_{\pi(i)}}{n_{\pi(i)}} \right)^2 \Var [  \epsilon_{k, \pi(i)}^t ] \right) +  \left( \frac{m_{\pi(i)}}{n_{\pi(i)}} \right)^2 \Var[ \xi_{\pi(i)}^t ] + \psi_i & \text{if } i = j \\
\sum_{k \neq \pi(i)} \left( 
\left( \frac{m_{\pi(i)}}{n_{\pi(i)}} \right)^2 \Var [ \epsilon_{k, \pi(i)}^t ] \right) +  \left( \frac{m_{\pi(i)}}{n_{\pi(i)}} \right)^2 \Var[ \xi_{\pi(i)}^t ] & \text{if } \pi(i) = \pi(j) \\
\frac{m_{\pi(i)}}{n_{\pi(j)}} \frac{m_{\pi(j)}}{n_{\pi(i)}} \frac{c_{\pi(j)}}{c_{\pi(i)}} \Var [\epsilon_{\pi(i), \pi(j)}^t] & \text{if } \pi(i) \neq \pi(j) \\
0 & \text{otherwise}
\end{cases}
$$

Each line of this equation has a simple interpretation. The first line describes the within district variance of shootings. This quantity is affected by the variance of all types of violence - non-gang, inter-gang, and intra-gang. The first term describes the variance in violence produced by conflicts between the gang occupying territory $i$ and all other gangs. The second term describes the variance in violence produced by conflict within the gang occupying territory $i$. The finally term describes the variance in violence from random (resident on resident) violence. If no gang occupies territory $i$ then the first two terms are zero by Assumptions `r Aintragang_nz` and `r Aintergang_symmetry`. The second line describes the covariance between two distinct districts that are controlled by the same gang. These districts all experience the violence produced when gang $\pi(i) = \pi(j)$ fights wars with any other gang. They also experience the internal violence germane to gang $\pi(i) = \pi(j)$. This quantity is zero if the territory is unoccupied by any gang. The third line descibes the covariance in violence between two districts controlled by different gangs. Violence in these districts covaries when the gangs controlling the two districts are at war. If either district $i$ or district $j$ is not occupied by a gang, then the covariance in violence will be zero, indicated by the last line of the equation.

One implication of Proposition `r Pcov`, is that districts that are owned by the same gang will experience similar patterns of violence. Corollary `r Ccov` formalizes the observation that for any pair of districts owned by the same pair of gangs will experience the same covariance in violence in expectation.   

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
Ccov <- Ctick
Ctick <- Ctick + 1
```

**Corollary `r Ccov` (Block Structure):** 

1. If $\pi(i) = \pi(j) = k$ and $i \neq j$ then $a_{ij} = b_{kk}$ constant for all $i, j$.
2. If $\pi(i) = k$ and $\pi(j) = \ell$ with $\ell \neq k$ then $a_{ij} = b_{k \ell}$ constant for all $i, j$.

If the partition function $\pi$ is known then the rows and columns of this matrix can be permuted to reveal the block structure described in Corollary `r Ccov`. Let $A_{N \times N} = (a_{ij})_{ \left\{ i,j \in \mathcal{N} \right\} }$ be the covariance matrix.^[Note also that this matrix is symmetric and positive definite.] Let $A(k, \ell)_{n_k \times n_\ell} = (a_{ij})_{ \left\{ i,j | \pi(i) = k, \pi(j) = \ell \right\} }$ be the submatrix where the row districts are controlled by $k$ and the column districts are controlled by $\ell$. To reveal the block structure, we rearrange district identifiers in accordance with their territorial assignment. Let $f$ be a bijection that maps $\mathcal{N}$ to itself. Specifically, $f$ permutes the district labels such that territories belonging to the same gang will have numerically adjacent labels. 
$$
f: \begin{cases}
\mathcal{K}_k \rightarrow \left\{ \sum_{\ell=1}^{k-1} ( n_{\ell} ) + 1, \dots, \sum_{\ell=1}^{k} ( n_{\ell} ) \right\} & \text{if } k \geq 1 \\
\mathcal{K}_0 \rightarrow \left\{ \sum_{\ell=1}^{K} ( n_{\ell} ) + 1, \dots, N \right\} & \text{if } k = 0
\end{cases}
$$
Then, let $P_{N \times N} = (p_{ij})_{ \left\{ i, j \in \mathcal{N} \right\} }$ be a permutation matrix with $p_{ij} = 1$ if $f(i) = j$ and $p_{ij} = 0$ otherwise. Let $\bar{A} = P A P$ denote the permuted covariance matrix. Then, 
\vspace{5mm}
$$
\footnotesize \bar{A} = \begin{bNiceArray}{CCCCC}
\overmat{\pi(i) = 1}{\begin{bmatrix}
    & & \\
    & A(1, 1)_{n_1 \times n_1} & \\
    & & 
\end{bmatrix}} & \overmat{\pi(i) = 2}{\begin{bmatrix}
    & & \\
    & A(1, 2)_{n_1 \times n_2} & \\
    & & 
\end{bmatrix}} & \cdots & \overmat{\pi(i) = K}{\begin{bmatrix}
    & & \\
    & A(1, K)_{n_1 \times n_K} & \\
    & & 
\end{bmatrix}} & \bm{0} \\
\begin{bmatrix}
    & & \\
    & A(2, 1)_{n_2 \times n_1} & \\
    & & 
\end{bmatrix} & \begin{bmatrix}
    & & \\
    & A(2, 2)_{n_2 \times n_2} & \\
    & & 
\end{bmatrix} & \cdots & \vdots & \bm{0} \\
\vdots & \vdots & \ddots & \vdots & \bm{0} \\
\begin{bmatrix}
    & & \\
    & A(K, 1)_{n_K \times n_1} & \\
    & & 
\end{bmatrix} & \cdots & \cdots & \begin{bmatrix}
    & & \\
    & A(K, K)_{n_K \times n_K} & \\
    & & 
\end{bmatrix} & \bm{0} \\
\bm{0} & \bm{0} & \bm{0}  & \bm{0} & \undermat{\pi(i) = 0}{
\begin{bmatrix}
    & & \\
    & A(0, 0)_{n_0 \times n_0} & \\
    & & 
\end{bmatrix}}
\end{bNiceArray}
$$
\vspace{5mm}

Figure \ref{fig:blocks} shows a schematic representation of this permutation. In the right column blocks and bottom row blocks are districts that are not controlled by any gang. These exhibit no covariance with other districts because the only shootings that occur there are from residents, and these are i.i.d. across districts. Along the block-diagonal are districts owned by the same gang. Shootings within a gang's territory covary for two reasons. First, shocks to within-gang relations ($\xi_k^t$) are shared by all districts controlled by a given gang. Second, members of gang $k$ operating in these districts share equally the risk of attacks that comes from *all* gang wars in which $k$ is a belligerent ($\epsilon_{k, \ell}^t$). On the off block-diagonal are covariances produced through *specific* gang wars. For example, $k, \ell$ block of the matrix is positive whenever $\E [ \epsilon_{k, \ell}^t ] > 0$, or there is a positive probability of conflict between gangs $k$ and $\ell$. The reason that shootings in the districts controlled by gangs $k$ and $\ell$ covary is because inter-gang shocks generate retaliatory violence (Assumption `r Aintergang_symmetry`).

![The input covariance matrix $A$ is shown in the left panel. Applying the transformation $P A P$ produces the block diagonal structure shown in the right panel. \label{fig:blocks}](05_figs/cartoons/block_mat.png)

This covariance matrix can be compactly represented as a function of our estimands, $K$ and $\pi$. Let $\Psi = \text{diag}(\psi_1, \dots \psi_N)$ denote a matrix comprised solely of a diagonal of the covariance generated by the non-gang related violence. Let $Q = A - \Psi$ denote the covariance matrix of the gang-related violence. Let $B_{K + 1 \times K + 1} = (b_{k \ell})_{ \left\{ k, \ell \in \mathcal{K} \right\} }$ store the constant block covariance values defined in Corollary `r Ccov` and note that $b_{k0} = b_{0k} = 0$ for all $k$. Finally, let $\Theta_{N \times K + 1} = (\theta_{ik})_{\left\{ i \in \mathcal{N}, k \in \mathcal{K} \cup 0 \right\} }$ be a membership matrix with $\theta_{ik} = 1$ if $\pi(i) = k$ and $0$ otherwise. Then, 
$$
Q = \Theta B \Theta^T .
$$

Readers may recognize this structure as similar in form to a stochastic blockmodel [@Holland1983]. In such models, nodes are partitioned into groups and interact with members of other groups with some latent probability determined by their group membership. These latent probabilities can be expressed in a *connectivity matrix* akin to our $B$. If counts of these interactions are observed, the partition function and connectivity matrix can be estimated using spectral clustering [@Jin2015; @Lei2015]. 

Here, we do not observe directly these interactions, and our $B$ matrix does not have this simple interpretation. However, under the assumptions of our model, the spatial covariance in shootings mirrors the structure of the stochastic blockmodel, as in @Trebbi2019. We can therefore employ existing methods to estimate our model using these data. 
